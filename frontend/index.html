<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Controller</title>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // API URL - змініть на свій
        const API_URL = 'http://192.168.68.111:3000/api';
        
        // SVG Icons
        const Icons = {
            Sun: ({className = "w-6 h-6"}) => (
                <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line x1="1" y1="12" x2="3" y2="12"/>
                    <line x1="21" y1="12" x2="23" y2="12"/>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                </svg>
            ),
            Power: ({className = "w-6 h-6"}) => (
                <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M18.36 6.64a9 9 0 1 1-12.73 0"/>
                    <line x1="12" y1="2" x2="12" y2="12"/>
                </svg>
            ),
            Wifi: ({className = "w-4 h-4"}) => (
                <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M5 12.55a11 11 0 0 1 14.08 0"/>
                    <path d="M1.42 9a16 16 0 0 1 21.16 0"/>
                    <path d="M8.53 16.11a6 6 0 0 1 6.95 0"/>
                    <line x1="12" y1="20" x2="12.01" y2="20"/>
                </svg>
            ),
            WifiOff: ({className = "w-4 h-4"}) => (
                <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="1" y1="1" x2="23" y2="23"/>
                    <path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/>
                    <path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/>
                    <path d="M10.71 5.05A16 16 0 0 1 22.58 9"/>
                    <path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/>
                    <path d="M8.53 16.11a6 6 0 0 1 6.95 0"/>
                    <line x1="12" y1="20" x2="12.01" y2="20"/>
                </svg>
            ),
            Plus: ({className = "w-5 h-5"}) => (
                <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
            ),
            Settings: ({className = "w-5 h-5"}) => (
                <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v6m0 6v6m9-9h-6m-6 0H3"/>
                </svg>
            ),
            Activity: ({className = "w-3 h-3"}) => (
                <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                </svg>
            ),
            Clock: ({className = "w-3 h-3"}) => (
                <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
            ),
            Trash2: ({className = "w-4 h-4"}) => (
                <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    <line x1="10" y1="11" x2="10" y2="17"/>
                    <line x1="14" y1="11" x2="14" y2="17"/>
                </svg>
            ),
            RefreshCw: ({className = "w-5 h-5"}) => (
                <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <polyline points="23 4 23 10 17 10"/>
                    <polyline points="1 20 1 14 7 14"/>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                </svg>
            )
        };
        
        function SolarControllerApp() {
            const [devices, setDevices] = useState([]);
            const [showAddDevice, setShowAddDevice] = useState(false);
            const [loading, setLoading] = useState(true);
            const [user, setUser] = useState({ telegramId: '123456', username: 'test_user' });
            
            useEffect(() => {
                // Створюємо користувача
                fetch(`${API_URL}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(user)
                })
                .then(res => res.json())
                .then(() => fetchDevices())
                .catch(console.error);
                
                // Оновлюємо кожні 5 секунд
                const interval = setInterval(fetchDevices, 5000);
                return () => clearInterval(interval);
            }, []);
            
            const fetchDevices = async () => {
                try {
                    const response = await fetch(`${API_URL}/devices/${user.telegramId}`);
                    const data = await response.json();
                    setDevices(data);
                    setLoading(false);
                } catch (error) {
                    console.error('Error fetching devices:', error);
                    setLoading(false);
                }
            };
            
            const toggleRelay = async (deviceId, currentState) => {
                try {
                    await fetch(`${API_URL}/devices/${deviceId}/control`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            command: 'relay',
                            state: !currentState
                        })
                    });
                    
                    setDevices(devices.map(d => 
                        d.device_id === deviceId 
                            ? { ...d, status: { ...d.status, relayState: !currentState } }
                            : d
                    ));
                } catch (error) {
                    console.error('Error toggling relay:', error);
                }
            };
            
            const deleteDevice = async (deviceId) => {
                if (!confirm('Видалити цей пристрій?')) return;
                
                try {
                    await fetch(`${API_URL}/devices/${deviceId}`, {
                        method: 'DELETE'
                    });
                    fetchDevices();
                } catch (error) {
                    console.error('Error deleting device:', error);
                }
            };
            
            const AddDeviceModal = () => {
                const [deviceId, setDeviceId] = useState('');
                const [confirmationCode, setConfirmationCode] = useState('');
                const [name, setName] = useState('');
                const [error, setError] = useState('');
                const [adding, setAdding] = useState(false);
                
                const handleAddDevice = async () => {
                    setError('');
                    setAdding(true);
                    
                    try {
                        const response = await fetch(`${API_URL}/devices`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                userId: user.telegramId,
                                deviceId,
                                confirmationCode,
                                name
                            })
                        });
                        
                        if (!response.ok) {
                            const data = await response.json();
                            throw new Error(data.error || 'Failed to add device');
                        }
                        
                        setShowAddDevice(false);
                        fetchDevices();
                    } catch (error) {
                        setError(error.message);
                        setAdding(false);
                    }
                };
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-2xl p-6 w-full max-w-md">
                            <h3 className="text-xl font-bold mb-4">Додати новий пристрій</h3>
                            
                            {error && (
                                <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm">
                                    {error}
                                </div>
                            )}
                            
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        ID пристрою
                                    </label>
                                    <input
                                        type="text"
                                        value={deviceId}
                                        onChange={(e) => setDeviceId(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="ESP32_XXXXXX"
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Код підтвердження
                                    </label>
                                    <input
                                        type="text"
                                        value={confirmationCode}
                                        onChange={(e) => setConfirmationCode(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="123456"
                                        maxLength="6"
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Назва (опціонально)
                                    </label>
                                    <input
                                        type="text"
                                        value={name}
                                        onChange={(e) => setName(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Сонячна панель гараж"
                                    />
                                </div>
                            </div>
                            
                            <div className="flex gap-3 mt-6">
                                <button
                                    onClick={() => setShowAddDevice(false)}
                                    className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                                    disabled={adding}
                                >
                                    Скасувати
                                </button>
                                <button
                                    onClick={handleAddDevice}
                                    className="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50"
                                    disabled={adding || !deviceId || !confirmationCode}
                                >
                                    {adding ? 'Додавання...' : 'Додати'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };
            
            const DeviceCard = ({ device }) => {
                const isOnline = device.status?.online || false;
                const relayState = device.status?.relayState || false;
                
                return (
                    <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                        <div className="flex items-center justify-between mb-3">
                            <h3 className="font-semibold text-gray-800">{device.name}</h3>
                            <div className="flex items-center gap-2">
                                {isOnline ? (
                                    <Icons.Wifi className="w-4 h-4 text-green-500" />
                                ) : (
                                    <Icons.WifiOff className="w-4 h-4 text-red-500" />
                                )}
                                <span className={`text-xs ${isOnline ? 'text-green-500' : 'text-red-500'}`}>
                                    {isOnline ? 'Онлайн' : 'Офлайн'}
                                </span>
                            </div>
                        </div>
                        
                        <div className="flex items-center justify-between">
                            <div className="text-sm text-gray-500">
                                {device.device_id}
                            </div>
                            
                            <div className="flex items-center gap-2">
                                <button
                                    onClick={() => deleteDevice(device.device_id)}
                                    className="p-2 text-gray-400 hover:text-red-500 transition-colors"
                                    title="Видалити пристрій"
                                >
                                    <Icons.Trash2 />
                                </button>
                                
                                <button
                                    onClick={() => toggleRelay(device.device_id, relayState)}
                                    disabled={!isOnline}
                                    className={`p-3 rounded-full transition-all ${
                                        relayState 
                                            ? 'bg-yellow-400 text-white shadow-lg' 
                                            : 'bg-gray-200 text-gray-600'
                                    } ${!isOnline ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-xl'}`}
                                >
                                    <Icons.Power />
                                </button>
                            </div>
                        </div>
                        
                        {device.status && isOnline && (
                            <div className="mt-3 pt-3 border-t border-gray-100 grid grid-cols-2 gap-2 text-xs">
                                <div className="flex items-center gap-1">
                                    <Icons.Activity />
                                    <span className="text-gray-600">RSSI: {device.status.wifiRSSI} dBm</span>
                                </div>
                                <div className="flex items-center gap-1">
                                    <Icons.Clock />
                                    <span className="text-gray-600">Uptime: {Math.floor((device.status.uptime || 0) / 3600)}h</span>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };
            
            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-yellow-50 flex items-center justify-center">
                        <div className="text-center">
                            <Icons.Sun className="w-12 h-12 text-yellow-500 animate-spin mx-auto mb-4" />
                            <p className="text-gray-600">Завантаження...</p>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-yellow-50">
                    {/* Header */}
                    <div className="bg-white shadow-sm border-b border-gray-100">
                        <div className="px-4 py-3">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                    <Icons.Sun className="w-8 h-8 text-yellow-500" />
                                    <h1 className="text-xl font-bold text-gray-800">Solar Controller</h1>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button 
                                        onClick={fetchDevices}
                                        className="p-2 hover:bg-gray-100 rounded-lg"
                                        title="Оновити"
                                    >
                                        <Icons.RefreshCw />
                                    </button>
                                    <button className="p-2 hover:bg-gray-100 rounded-lg">
                                        <Icons.Settings />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Content */}
                    <div className="p-4">
                        {/* Stats */}
                        <div className="grid grid-cols-2 gap-3 mb-6">
                            <div className="bg-white rounded-xl p-4 shadow-sm">
                                <div className="flex items-center gap-2 mb-1">
                                    <Icons.Power className="w-4 h-4 text-blue-500" />
                                    <span className="text-sm text-gray-600">Активні</span>
                                </div>
                                <p className="text-2xl font-bold text-gray-800">
                                    {devices.filter(d => d.status?.relayState).length}
                                </p>
                            </div>
                            <div className="bg-white rounded-xl p-4 shadow-sm">
                                <div className="flex items-center gap-2 mb-1">
                                    <Icons.Wifi className="w-4 h-4 text-green-500" />
                                    <span className="text-sm text-gray-600">Онлайн</span>
                                </div>
                                <p className="text-2xl font-bold text-gray-800">
                                    {devices.filter(d => d.status?.online).length}
                                </p>
                            </div>
                        </div>
                        
                        {/* Devices */}
                        <div className="space-y-3">
                            {devices.map(device => (
                                <DeviceCard key={device.id} device={device} />
                            ))}
                            
                            {/* Add Device Button */}
                            <button
                                onClick={() => setShowAddDevice(true)}
                                className="w-full bg-white rounded-2xl p-4 shadow-sm border-2 border-dashed border-gray-300 hover:border-blue-400 hover:bg-blue-50 transition-all group"
                            >
                                <div className="flex items-center justify-center gap-2 text-gray-600 group-hover:text-blue-600">
                                    <Icons.Plus />
                                    <span className="font-medium">Додати пристрій</span>
                                </div>
                            </button>
                        </div>
                        
                        {devices.length === 0 && (
                            <div className="text-center py-8">
                                <Icons.Sun className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                                <p className="text-gray-500">Немає підключених пристроїв</p>
                                <p className="text-sm text-gray-400 mt-2">Натисніть кнопку вище щоб додати перший</p>
                            </div>
                        )}
                    </div>
                    
                    {/* Modals */}
                    {showAddDevice && <AddDeviceModal />}
                </div>
            );
        }
         
        // Рендеримо додаток
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SolarControllerApp />);
    </script>
</body>
</html>
